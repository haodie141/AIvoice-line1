# v2.0 部署指南

> 版本: v2.0
> 部署日期: 2024-12-XX

---

## 目录

- [部署前准备](#部署前准备)
- [代码更新](#代码更新)
- [配置文件](#配置文件)
- [部署步骤](#部署步骤)
- [验证测试](#验证测试)
- [回滚方案](#回滚方案)
- [常见问题](#常见问题)

---

## 部署前准备

### 1. 环境检查

```bash
# 检查 Python 版本（要求 3.12+）
python --version

# 检查当前运行的服务
ps aux | grep python

# 检查端口占用
lsof -i :8000  # 或你使用的端口
```

### 2. 备份当前版本

```bash
# 备份当前代码
cd /path/to/AIvoice-line1
git checkout -b backup_before_v2_0

# 备份配置文件（如果有自定义配置）
cp -r config config.backup
```

### 3. 准备回滚方案

```bash
# 记录当前 commit
git log --oneline -1
# 输出示例: 86e2034 docs: 更新 README.md，添加详细的项目文档和使用指南
```

---

## 代码更新

### 1. 拉取最新代码

```bash
# 切换到 main 分支
git checkout main

# 拉取最新代码
git pull origin main

# 查看最新提交
git log --oneline -3
```

### 2. 需要修改的文件清单

```
src/graphs/state.py                    # 修改：增加 scenario_type 字段
src/graphs/node.py                     # 修改：新增 quick_reply_node, quick_chat_node
src/graphs/graph.py                    # 修改：调整工作流结构
src/storage/memory_store.py            # 修改：增加 homework_check 时间记录
config/quick_reply_llm_cfg.json        # 新增：快速回复配置
config/quick_chat_llm_cfg.json         # 新增：轻量级聊天配置
```

### 3. 代码变更说明

#### src/graphs/state.py

```python
# 修改 GraphInput
class GraphInput(BaseModel):
    # ... 原有字段

    # 新增字段
    scenario_type: Literal[
        "chat",          # 闲聊
        "homework",      # 作业相关
        "practice",      # 练习
        "fact_query",    # 事实查询
        "general"        # 通用（默认）
    ] = Field(
        default="general",
        description="场景类型，用于优化路由和短路不必要节点"
    )

# 修改 GraphOutput
class GraphOutput(BaseModel):
    # 新增字段
    quick_response: str = Field(
        default="",
        description="快速回复（优先返回，提升首字延迟）"
    )
    followup_question: str = Field(
        default="",
        description="追问内容"
    )
    scenario_type: str = Field(
        default="",
        description="实际执行的场景类型"
    )
    execution_path: List[str] = Field(
        default=[],
        description="执行路径（节点列表）"
    )
    performance_metrics: dict = Field(
        default={},
        description="性能指标"
    )

    # ... 原有字段
```

#### src/graphs/node.py

```python
# 新增：快速回复节点
def quick_reply_node(
    state: QuickReplyInput,
    config: RunnableConfig,
    runtime: Runtime[Context]
) -> QuickReplyOutput:
    """
    title: 快速回复节点
    desc: 先输出简短回复+追问，提升首字延迟
    integrations: 大语言模型
    """
    # ... 实现代码

# 新增：轻量级聊天节点
def quick_chat_node(
    state: QuickChatInput,
    config: RunnableConfig,
    runtime: Runtime[Context]
) -> QuickChatOutput:
    """
    title: 轻量级聊天节点
    desc: 闲聊场景专用，跳过搜索、作业判断，只保留核心对话
    integrations: 大语言模型
    """
    # ... 实现代码

# 修改：增强路由决策
def enhanced_route_decision(state: LoadMemoryWrapOutput) -> str:
    """增强的路由决策：基于场景类型短路"""
    # ... 实现代码
```

#### src/graphs/graph.py

```python
# 修改工作流结构
builder = StateGraph(GlobalState, input_schema=GraphInput, output_schema=GraphOutput)

# 添加新节点
builder.add_node("quick_reply", quick_reply_node, metadata={
    "type": "agent",
    "llm_cfg": "config/quick_reply_llm_cfg.json"
})
builder.add_node("quick_chat", quick_chat_node, metadata={
    "type": "agent",
    "llm_cfg": "config/quick_chat_llm_cfg.json"
})

# 调整边：在 route_decision 后先执行 quick_reply
builder.add_edge("load_memory", "quick_reply")
builder.add_edge("quick_reply", "enhanced_route_decision")

# 调整路由
builder.add_conditional_edges(
    source="enhanced_route_decision",
    path=enhanced_route_decision,
    path_map={
        "主动关心": "active_care",
        "作业提醒": "homework_check",
        "口语练习": "speaking_practice",
        "轻量聊天": "quick_chat",
        "实时对话": "realtime_conversation"
    }
)
```

#### src/storage/memory_store.py

```python
class MemoryStore:
    # 新增：记录作业检查时间
    def record_homework_check(self, session_id: str):
        """记录作业检查时间"""
        if session_id not in self.homework_checks:
            self.homework_checks[session_id] = {}

        self.homework_checks[session_id]["last_check"] = datetime.now()

    # 新增：获取最后检查时间
    def get_last_homework_check(self, session_id: str) -> Optional[datetime]:
        """获取最后作业检查时间"""
        if session_id in self.homework_checks and "last_check" in self.homework_checks[session_id]:
            return self.homework_checks[session_id]["last_check"]
        return None
```

---

## 配置文件

### 1. config/quick_reply_llm_cfg.json

```json
{
  "config": {
    "model": "doubao-seed-1-8-251228",
    "temperature": 0.7,
    "topk": 0.9,
    "max_tokens": 50
  },
  "tools": [],
  "sp": "你是孩子的AI朋友，正在生成快速回复。请用一句话简短回复（不超过20字），并提一个相关追问。不要包含表情符号，不要包含动作描述。",
  "up": "孩子说：{{user_input_text}}\n\n请生成回复，格式：回复。追问？\n\n示例：\n用户：今天天气怎么样？\n回复：今天晴天。想出去玩吗？"
}
```

### 2. config/quick_chat_llm_cfg.json

```json
{
  "config": {
    "model": "doubao-seed-1-8-251228",
    "temperature": 0.8,
    "topk": 0.9,
    "max_tokens": 100
  },
  "tools": [],
  "sp": "你是孩子的AI朋友，正在进行轻松的闲聊。请用友好、亲切的语气回复，不需要搜索信息，不需要讨论作业。不要包含表情符号，不要包含动作描述。",
  "up": "最近对话：\n{{conversation_history}}\n\n孩子说：{{user_input_text}}\n\n请回复。"
}
```

### 3. 环境变量

**无需新增环境变量**，使用现有配置：

```bash
# 设置运行模式（可选，默认为 full_companion）
export COZE_GRAPH_MODE=full_companion  # 完整模式
# export COZE_GRAPH_MODE=detailed        # 可视化模式
# export COZE_GRAPH_MODE=realtime_call   # 实时通话模式

# 设置工作目录（可选，默认为当前目录）
export COZE_WORKSPACE_PATH=/path/to/workspace
```

---

## 部署步骤

### 方式1：直接部署（推荐）

```bash
# 1. 停止当前服务
pkill -f "python.*main.py"  # 或使用 systemd/systemctl 停止

# 2. 拉取最新代码
git pull origin main

# 3. 安装依赖（如果有新依赖）
pip install -r requirements.txt

# 4. 启动服务
bash scripts/http_run.sh -m http -p 8000 &

# 5. 查看日志
tail -f /app/work/logs/bypass/app.log
```

### 方式2：Docker 部署

```bash
# 1. 构建镜像
docker build -t ai-companion:v2.0 .

# 2. 停止旧容器
docker stop ai-companion
docker rm ai-companion

# 3. 启动新容器
docker run -d \
  --name ai-companion \
  -p 8000:8000 \
  -e COZE_GRAPH_MODE=full_companion \
  ai-companion:v2.0

# 4. 查看日志
docker logs -f ai-companion
```

### 方式3：Systemd 服务

```bash
# 1. 创建/编辑服务文件
sudo vim /etc/systemd/system/ai-companion.service

# 2. 服务内容
[Unit]
Description=AI Companion Service
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/AIvoice-line1
ExecStart=/usr/bin/python /path/to/AIvoice-line1/src/main.py -m http -p 8000
Restart=always
RestartSec=10
Environment=COZE_GRAPH_MODE=full_companion

[Install]
WantedBy=multi-user.target

# 3. 重载并重启
sudo systemctl daemon-reload
sudo systemctl restart ai-companion

# 4. 查看状态
sudo systemctl status ai-companion
sudo journalctl -u ai-companion -f
```

---

## 验证测试

### 1. 健康检查

```bash
# 检查服务状态
curl http://localhost:8000/health

# 预期输出
{
  "status": "ok",
  "message": "Service is running"
}
```

### 2. 获取接口定义

```bash
curl http://localhost:8000/graph_parameter

# 验证响应中包含新字段：
# - quick_response
# - followup_question
# - scenario_type
```

### 3. 功能测试

#### 测试1：闲聊场景

```bash
curl -X POST http://localhost:8000/run \
  -H "Content-Type: application/json" \
  -d '{
    "child_id": "test_001",
    "child_name": "测试",
    "child_age": 10,
    "trigger_type": "conversation",
    "user_input_text": "你好",
    "scenario_type": "chat"
  }'
```

**验证点**:
- ✅ 响应时间 < 2秒
- ✅ 包含 `quick_response` 字段
- ✅ 包含 `followup_question` 字段
- ✅ `scenario_type` = "chat"

#### 测试2：作业查询

```bash
curl -X POST http://localhost:8000/run \
  -H "Content-Type: application/json" \
  -d '{
    "child_id": "test_001",
    "child_name": "测试",
    "child_age": 10,
    "trigger_type": "conversation",
    "user_input_text": "作业做完了",
    "scenario_type": "homework",
    "homework_list": [
      {"id": "hw_001", "subject": "数学", "task": "练习册", "due_date": "2024-12-20"}
    ]
  }'
```

**验证点**:
- ✅ `homework_status` = "completed"
- ✅ 包含 `quick_response` 字段
- ✅ 响应时间 < 2.5秒

#### 测试3：向后兼容性

```bash
curl -X POST http://localhost:8000/run \
  -H "Content-Type: application/json" \
  -d '{
    "child_id": "test_001",
    "child_name": "测试",
    "child_age": 10,
    "user_input_text": "你好"
  }'
```

**验证点**:
- ✅ 不传 `scenario_type` 也能正常工作
- ✅ 自动判定场景类型
- ✅ 响应包含所有字段

### 4. 性能测试

```bash
# 测试响应时间
time curl -X POST http://localhost:8000/run \
  -H "Content-Type: application/json" \
  -d '{
    "child_id": "test_001",
    "child_name": "测试",
    "child_age": 10,
    "user_input_text": "你好"
  }'

# 预期结果：real < 2.0s
```

### 5. 并发测试

```bash
# 使用 Apache Bench 测试并发
ab -n 100 -c 10 -T "application/json" \
  -p request_body.json \
  http://localhost:8000/run

# request_body.json 内容:
{
  "child_id": "test_001",
  "child_name": "测试",
  "child_age": 10,
  "user_input_text": "你好"
}
```

---

## 回滚方案

### 1. 快速回滚（推荐）

```bash
# 1. 停止服务
pkill -f "python.*main.py"

# 2. 回退到 v1.0
git checkout v1.0

# 3. 重启服务
bash scripts/http_run.sh -m http -p 8000 &

# 4. 验证
curl http://localhost:8000/health
```

### 2. 备份回滚

```bash
# 1. 恢复备份分支
git checkout backup_before_v2_0

# 2. 重启服务
bash scripts/http_run.sh -m http -p 8000 &
```

### 3. 配置文件回滚

```bash
# 如果只需回滚配置
cp -r config.backup/* config/
pkill -f "python.*main.py"
bash scripts/http_run.sh -m http -p 8000 &
```

---

## 常见问题

### Q1: 部署后服务无法启动

**检查步骤**:

```bash
# 1. 查看错误日志
tail -n 50 /app/work/logs/bypass/app.log

# 2. 检查端口占用
lsof -i :8000

# 3. 手动启动查看详细错误
cd /path/to/AIvoice-line1
python src/main.py -m http -p 8000
```

**常见原因**:
- 端口被占用 → 修改端口或停止占用进程
- 依赖缺失 → `pip install -r requirements.txt`
- 配置文件错误 → 检查 JSON 格式

### Q2: 新字段不显示

**检查步骤**:

```bash
# 1. 检查代码是否正确部署
git log --oneline -1

# 2. 检查服务是否重启
ps aux | grep "python.*main.py"

# 3. 查看接口定义
curl http://localhost:8000/graph_parameter
```

**解决方案**:
```bash
# 确保拉取最新代码
git pull origin main

# 重启服务
pkill -f "python.*main.py"
bash scripts/http_run.sh -m http -p 8000 &
```

### Q3: 响应时间没有改善

**检查步骤**:

```bash
# 1. 检查运行模式
echo $COZE_GRAPH_MODE

# 2. 查看性能指标
curl -X POST http://localhost:8000/run \
  -H "Content-Type: application/json" \
  -d '{"child_id":"test","child_name":"test","child_age":10,"user_input_text":"你好"}' \
  | jq .performance_metrics

# 3. 检查 LLM 调用次数
# 如果 llm_calls > 2，可能是规则判断未生效
```

**解决方案**:
```bash
# 切换到 full_companion 模式
export COZE_GRAPH_MODE=full_companion

# 重启服务
pkill -f "python.*main.py"
bash scripts/http_run.sh -m http -p 8000 &
```

### Q4: 旧客户端无法正常使用

**检查步骤**:

```bash
# 测试向后兼容性
curl -X POST http://localhost:8000/run \
  -H "Content-Type: application/json" \
  -d '{
    "child_id": "test_001",
    "child_name": "测试",
    "child_age": 10,
    "user_input_text": "你好"
  }'
```

**预期结果**:
- ✅ 返回正常
- ✅ 包含所有原有字段
- ✅ 新字段有默认值

### Q5: 音频文件无法识别

**检查步骤**:

```bash
# 1. 验证音频 URL 可访问
curl -I https://example.com/audio.mp3

# 2. 检查音频格式
file audio.mp3

# 3. 查看日志
tail -f /app/work/logs/bypass/app.log | grep -i audio
```

**解决方案**:
- 确保 URL 可访问（非私有网）
- 使用标准格式（MP3, WAV）
- 检查音频大小（建议 < 10MB）

### Q6: 作业状态未更新

**检查步骤**:

```bash
# 1. 检查记忆存储
python -c "from src.storage.memory_store import MemoryStore; ms = MemoryStore.get_instance(); print(ms.get_homework_list('child_001'))"

# 2. 查看日志
tail -f /app/work/logs/bypass/app.log | grep -i homework

# 3. 验证作业判断是否触发
# 检查 performance_metrics 中的 llm_calls
```

**解决方案**:
- 确保用户话语中包含关键词（做完、完成、交了）
- 检查 homework_list 格式是否正确
- 查看日志中的作业判断结果

---

## 监控建议

### 1. 关键指标

```bash
# 监控响应时间
tail -f /app/work/logs/bypass/app.log | grep "total_time_ms"

# 监控 LLM 调用次数
tail -f /app/work/logs/bypass/app.log | grep "llm_calls"

# 监控错误
tail -f /app/work/logs/bypass/app.log | grep -i error
```

### 2. 告警阈值

| 指标 | 阈值 | 告警级别 |
|------|------|----------|
| 响应时间 | > 3秒 | Warning |
| 响应时间 | > 5秒 | Critical |
| 错误率 | > 5% | Warning |
| 错误率 | > 10% | Critical |
| LLM 调用失败率 | > 5% | Warning |

### 3. 日志分析

```bash
# 统计响应时间
grep "total_time_ms" /app/work/logs/bypass/app.log | awk '{print $NF}' | sort -n | tail -10

# 统计场景分布
grep "scenario_type" /app/work/logs/bypass/app.log | awk '{print $NF}' | sort | uniq -c

# 统计错误
grep -i "error" /app/work/logs/bypass/app.log | awk '{print $NF}' | sort | uniq -c
```

---

## 联系支持

如果部署过程中遇到问题：

1. 查看日志：`tail -f /app/work/logs/bypass/app.log`
2. 检查文档：`docs/工作流改进说明.md` 和 `docs/API返回样例.md`
3. 提交 Issue：https://github.com/haodie141/AIvoice-line1/issues

---

**文档版本**: v2.0
**最后更新**: 2024-12-XX
**维护者**: AI 陪伴团队
