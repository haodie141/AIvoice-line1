# 模式切换指南

## 支持的模式

本项目支持两种工作模式，针对不同场景优化：

### 1. full_companion（完整陪伴机器人）- 默认模式
**适合场景：** 家庭教育、作业管理、情感陪伴

**功能：**
- ✅ 实时对话
- ✅ 作业管理（智能提醒、时间有效性判断、自动识别完成）
- ✅ 主动关心（时间感知、个性化话题）
- ✅ 口语练习（语音识别、纠错、反馈）
- ✅ 长期记忆（对话历史、学习进度）

**工作流程：**
```
加载记忆 → 路由判断 → 业务节点 → 语音合成 → 保存记忆
```

**延迟：** 中等（约2-3秒）

---

### 2. realtime_call（低延迟实时通话）
**适合场景：** 实时语音通话、需要快速响应的对话

**功能：**
- ✅ 实时对话
- ✅ 语音识别（ASR）
- ✅ 语音合成（TTS）
- ⚠️ 不包含作业管理、主动关心等高级功能
- ⚠️ 对话历史有限

**工作流程：**
```
ASR → LLM → TTS
```

**优化：**
- 精简节点，去除非必要步骤
- LLM max_tokens=300，减少生成时间
- 线性流程，无分支判断
- 跳过保存记忆步骤

**延迟：** 低（约1-2秒）

---

## 切换模式

### 方法1：环境变量（推荐）

启动服务前设置环境变量：

```bash
# 低延迟实时通话模式
export COZE_GRAPH_MODE=realtime_call

# 完整陪伴机器人模式（默认）
export COZE_GRAPH_MODE=full_companion
```

然后启动服务：
```bash
bash scripts/http_run.sh -m http -p 5000
```

### 方法2：直接修改代码

编辑 `src/graphs/graph.py`，找到模式切换部分：

```python
GRAPH_MODE = os.getenv("COZE_GRAPH_MODE", "full_companion").lower()
```

将默认值改为 `"realtime_call"` 即可。

---

## 性能对比

| 指标 | full_companion | realtime_call |
|-----|----------------|---------------|
| 功能完整度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 响应延迟 | 2-3秒 | 1-2秒 |
| 作业管理 | ✅ | ❌ |
| 主动关心 | ✅ | ❌ |
| 口语练习 | ✅ | ❌ |
| 长期记忆 | ✅ | ⚠️ 有限 |
| 适用场景 | 家庭教育 | 实时通话 |

---

## 实时通话模式的特点

1. **极简流程**
   - 只保留 ASR、LLM、TTS 三个核心节点
   - 线性流程，无分支判断

2. **优化参数**
   - LLM max_tokens=300（约100字）
   - 减少生成时间

3. **输入简化**
   - 支持纯音频输入，无需其他参数
   - 默认配置可直接使用

4. **快速响应**
   - 跳过保存记忆步骤
   - 减少节点跳转次数

---

## 使用示例

### 实时通话模式

```json
{
  "user_input_audio": {
    "url": "https://example.com/audio.mp3",
    "file_type": "audio"
  }
}
```

### 完整陪伴机器人模式

```json
{
  "child_name": "小明",
  "child_age": 8,
  "child_interests": ["阅读", "游戏"],
  "trigger_type": "conversation",
  "user_input_audio": {
    "url": "https://example.com/audio.mp3",
    "file_type": "audio"
  }
}
```

---

## 建议

- **实时通话场景**：使用 `realtime_call` 模式，追求低延迟
- **家庭教育场景**：使用 `full_companion` 模式，功能更全面
- **测试开发阶段**：可以使用 `realtime_call` 模式，快速迭代
- **生产环境**：根据实际需求选择模式

---

## 注意事项

1. 切换模式需要重启服务
2. 两种模式的输入输出格式略有不同
3. 实时通话模式不支持作业管理等高级功能
4. 长期记忆在实时通话模式下功能受限
