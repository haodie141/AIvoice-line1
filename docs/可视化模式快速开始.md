# 可视化模式快速开始指南

## 🎉 功能完成

工作流现在支持**三种运行模式**，可以通过环境变量自由切换：

1. **完整模式**（full_companion）- 默认，性能最优
2. **可视化模式**（detailed）- 步骤级拆分，类似扣子工作流 ⭐
3. **实时通话模式**（realtime_call）- 低延迟，用于实时对话

---

## 🚀 快速开始

### 切换到可视化模式

```bash
# 设置环境变量
export COZE_GRAPH_MODE=detailed

# 重启服务
python src/main.py
```

### 切换回完整模式

```bash
# 设置环境变量
export COZE_GRAPH_MODE=full_companion

# 重启服务
python src/main.py
```

### 永久设置模式

**Linux/Mac:**
```bash
echo 'export COZE_GRAPH_MODE=detailed' >> ~/.bashrc
source ~/.bashrc
```

**Windows:**
```powershell
[System.Environment]::SetEnvironmentVariable('COZE_GRAPH_MODE', 'detailed', 'User')
```

---

## 📊 可视化效果

### 完整模式（7个节点）
```
输入 → 加载记忆 → 路由决策
  ├─ 主动关心 → TTS → 保存记忆
  ├─ 作业提醒 → TTS → 保存记忆
  ├─ 口语练习（单节点）→ TTS → 保存记忆
  └─ 实时对话（单节点）→ TTS → 保存记忆
```

### 可视化模式（17个节点）
```
输入 → 加载记忆 → 路由决策
  ├─ 主动关心 → TTS → 保存记忆
  ├─ 作业提醒 → TTS → 保存记忆
  ├─ 口语练习（7个步骤）
  │   ├─ 1. ASR（语音识别）
  │   ├─ 2. 复习检查（间隔重复算法）
  │   ├─ 3. 场景选择
  │   ├─ 4. 对话引擎（四阶段）
  │   ├─ 5. 知识点识别
  │   ├─ 6. 更新记忆
  │   └─ 7. TTS合成
  └─ 实时对话（5个步骤）
      ├─ 1. 搜索判断
      ├─ 2. 联网搜索
      ├─ 3. 上下文构建
      ├─ 4. LLM生成
      └─ 5. 作业意图识别
```

---

## 📁 新增文件

1. **src/graphs/visual_state.py** - 可视化模式的状态定义
2. **src/graphs/visual_node.py** - 可视化模式的节点函数
3. **src/graphs/visual_graph.py** - 可视化模式的图结构

---

## 📖 详细文档

- [模式切换指南](./模式切换指南.md) - 详细的模式切换说明
- [节点内部流程说明](./节点内部流程说明.md) - 每个节点的详细流程
- [可视化优化说明](./可视化优化说明.md) - 可视化方案说明

---

## ✅ 测试验证

运行测试脚本验证两种模式都能正常工作：

```bash
PYTHONPATH=/workspace/projects/src:$PYTHONPATH python test_visual_mode.py
```

预期输出：
```
✅ 可视化模式导入成功
图中的节点数量: 18

✅ 完整模式导入成功
图中的节点数量: 8

🎉 所有测试通过！两种模式都可以正常工作。
```

---

## 💡 使用建议

| 场景 | 推荐模式 | 原因 |
|------|---------|------|
| 生产环境 | full_companion | 性能最优 |
| 开发调试 | detailed | 可视化清晰 |
| 向他人展示 | detailed | 步骤级展示 |
| 实时对话 | realtime_call | 低延迟 |

---

## ⚠️ 注意事项

1. **切换模式需要重启服务**：修改环境变量后必须重启服务
2. **性能影响**：可视化模式有约300-500ms的额外开销
3. **数据兼容**：三种模式使用相同的存储，数据完全兼容
4. **默认模式**：不设置环境变量时，默认使用完整模式

---

## 🎯 可视化模式的节点列表

可视化模式包含17个节点：

### 公共节点
1. `load_memory` - 加载长期记忆
2. `tts` - 语音合成
3. `save_memory` - 保存记忆

### 主动关心分支
4. `active_care` - 主动关心（Agent节点）

### 作业提醒分支
5. `homework_check` - 作业检查

### 口语练习分支（7个步骤）
6. `practice_asr` - 语音识别
7. `practice_review_check` - 复习检查
8. `practice_scenario_select` - 场景选择
9. `practice_dialogue` - 对话引擎
10. `practice_knowledge_extract` - 知识点识别
11. `practice_update_memory` - 更新记忆
12. `practice_tts` - TTS合成

### 实时对话分支（5个步骤）
13. `realtime_search_judgment` - 搜索判断
14. `realtime_web_search` - 联网搜索
15. `realtime_context_builder` - 上下文构建
16. `realtime_llm_generate` - LLM生成
17. `realtime_homework_check` - 作业意图识别

---

## 🔧 技术细节

### 可视化模式架构
- **状态文件**：`src/graphs/visual_state.py`
- **节点函数**：`src/graphs/visual_node.py`
- **图结构**：`src/graphs/visual_graph.py`
- **切换逻辑**：`src/graphs/graph.py`（末尾）

### 模式切换实现
```python
import os

GRAPH_MODE = os.getenv("COZE_GRAPH_MODE", "full_companion").lower()

if GRAPH_MODE == "detailed":
    from graphs.visual_graph import visual_graph
    main_graph = visual_graph
    print("✅ 已切换到可视化模式")
elif GRAPH_MODE == "full_companion":
    main_graph = builder.compile()
    print("✅ 使用完整陪伴机器人模式")
elif GRAPH_MODE == "realtime_call":
    from graphs.realtime_call_graph import realtime_call_graph
    main_graph = realtime_call_graph
    print("✅ 已切换到低延迟实时通话模式")
```

---

## 📞 获取帮助

如果遇到问题，请：
1. 查看日志输出，确认当前模式
2. 参考 [模式切换指南](./模式切换指南.md)
3. 运行测试脚本验证：`python test_visual_mode.py`

---

**祝你使用愉快！** 🎉
