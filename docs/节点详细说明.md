# 节点详细说明

本文档详细说明 AI 陪伴孩子智能体工作流中每个节点的输入、输出、处理过程和集成服务。

## 目录

- [完整模式节点（graphs/node.py）](#完整模式节点)
- [可视化模式节点（graphs/visual_node.py）](#可视化模式节点)
- [实时通话模式节点（graphs/realtime_call_graph.py）](#实时通话模式节点)

---

## 完整模式节点（graphs/node.py）

### 1. 长期记忆节点（long_term_memory_node）

#### 功能描述
加载或保存孩子的长期记忆，包括对话历史、学习进度和口语练习次数。

#### 输入字段（LongTermMemoryInput）

```python
class LongTermMemoryInput(BaseModel):
    child_id: str                          # 孩子ID
    action_type: Literal["load", "save"]   # 操作类型：加载/保存
    conversation_record: Optional[dict]    # 要保存的对话记录
    learning_progress: Optional[dict]      # 学习进度数据
```

#### 输出字段（LongTermMemoryOutput）

```python
class LongTermMemoryOutput(BaseModel):
    conversation_history: List[dict]       # 对话历史
    learning_progress: dict                # 学习进度
    speaking_practice_count: int           # 口语练习次数
    load_success: bool                     # 加载是否成功
    save_success: bool                     # 保存是否成功
```

#### 处理过程

1. **加载记忆（action_type="load"）**
   - 从 MemoryStore 获取孩子的对话历史
   - 从 MemoryStore 获取学习进度
   - 从 MemoryStore 获取口语练习次数
   - 返回加载结果

2. **保存记忆（action_type="save"）**
   - 将对话记录保存到 MemoryStore
   - 将学习进度保存到 MemoryStore
   - 返回保存结果

#### 集成服务
- 无（使用内存存储）

---

### 2. 作业检查节点（homework_check_node）

#### 功能描述
检查孩子的作业状态，判断是否需要提醒，并生成提醒消息。

#### 输入字段（HomeworkCheckInput）

```python
class HomeworkCheckInput(BaseModel):
    homework_list: List[dict]    # 作业列表
    current_time: str            # 当前时间
    child_id: str                # 孩子ID
```

#### 输出字段（HomeworkCheckOutput）

```python
class HomeworkCheckOutput(BaseModel):
    homework_status: str         # 作业状态：未开始/进行中/已完成/无作业
    need_remind: bool            # 是否需要提醒
    remind_message: str          # 提醒消息
```

#### 处理过程

1. **筛选有效作业**
   - 过滤掉 7 天前的过期作业
   - 获取所有未完成的作业

2. **判断作业状态**
   - 如果没有有效作业：`homework_status = "无作业"`, `need_remind = False`
   - 如果有未完成作业：`homework_status = "未开始"`, `need_remind = True`

3. **生成提醒消息**
   - 基于孩子的年龄和兴趣生成个性化提醒
   - 使用大语言模型生成温暖的提醒话术

#### 集成服务
- 大语言模型（active_care_llm_cfg.json）

---

### 3. 主动关心节点（active_care_node）

#### 功能描述
主动发起关心对话，识别孩子的情绪并提供情感支持。

#### 输入字段（ActiveCareInput）

```python
class ActiveCareInput(BaseModel):
    child_name: str                      # 孩子姓名
    child_age: int                       # 孩子年龄
    child_interests: List[str]           # 孩子兴趣爱好
    conversation_history: List[dict]     # 对话历史
    current_time: str                    # 当前时间
```

#### 输出字段（ActiveCareOutput）

```python
class ActiveCareOutput(BaseModel):
    care_message: str                    # 关心消息
```

#### 处理过程

1. **分析孩子状态**
   - 根据对话历史判断孩子的情绪
   - 考虑孩子的兴趣爱好和年龄

2. **生成关心话术**
   - 使用大语言模型生成温暖、关心的对话
   - 选择适合孩子年龄的表达方式
   - 包含具体、可操作的建议

3. **危机检测**
   - 检测对话中的负面情绪
   - 如果检测到危机，优先提供情感支持

#### 集成服务
- 大语言模型（active_care_llm_cfg.json）

---

### 4. 口语练习节点（speaking_practice_node）

#### 功能描述
提供多阶段口语练习，包括主动引导、苏格拉底式提问、追问延伸和总结反馈。

#### 输入字段（SpeakingPracticeInput）

```python
class SpeakingPracticeInput(BaseModel):
    user_input_audio: Optional[File]      # 用户输入音频
    user_input_text: str                  # 用户输入文本
    child_name: str                       # 孩子姓名
    child_age: int                        # 孩子年龄
    child_interests: List[str]            # 孩子兴趣爱好
    conversation_history: List[dict]      # 对话历史
    practice_stage: Optional[str]         # 练习阶段
    is_first_turn: bool                   # 是否第一轮
```

#### 输出字段（SpeakingPracticeOutput）

```python
class SpeakingPracticeOutput(BaseModel):
    recognized_text: str                  # 识别出的文本
    feedback: str                         # 反馈内容
    practice_count: int                   # 练习次数
```

#### 处理过程（多阶段）

**阶段 1：主动引导**
- 场景化练习库：日常生活、学校、兴趣等
- 生成开放性问题，引导孩子表达

**阶段 2：苏格拉底式提问**
- 不直接纠正，而是通过提问引导孩子思考
- 鼓励孩子自己发现问题和答案

**阶段 3：追问延伸**
- 基于孩子的回答进行追问
- 拓展对话深度，鼓励详细表达

**阶段 4：总结反馈**
- 总结对话内容
- 提供正面鼓励和具体建议
- 识别知识点并存储到知识追踪系统

#### 集成服务
- 大语言模型（spoken_practice_llm_cfg.json）
- 语音识别（ASR）
- 语音合成（TTS）
- 知识追踪系统

---

### 5. 实时对话节点（realtime_conversation_node）

#### 功能描述
实时对话，支持上下文理解、联网检索和作业完成意图识别。

#### 输入字段（RealtimeConversationInput）

```python
class RealtimeConversationInput(BaseModel):
    user_input_text: str                  # 用户输入文本
    child_name: str                       # 孩子姓名
    child_age: int                        # 孩子年龄
    conversation_history: List[dict]      # 对话历史
    context_info: str                     # 上下文信息（如作业状态）
```

#### 输出字段（RealtimeConversationOutput）

```python
class RealtimeConversationOutput(BaseModel):
    ai_response: str                      # AI响应
```

#### 处理过程

1. **搜索判断（v2.0 优化）**
   - 使用规则匹配（覆盖 95% 场景）
   - LLM 兜底判断（5% 场景）
   - 决定是否需要联网搜索

2. **联网检索（如果需要）**
   - 调用联网搜索工具
   - 基于搜索结果生成回答

3. **生成回复**
   - 使用大语言模型生成对话
   - 考虑对话历史和上下文
   - 保持温暖、适合孩子的语气

4. **作业完成判断**
   - 使用第二个 LLM 判断是否提到作业完成
   - 如果确认，更新作业状态

#### 集成服务
- 大语言模型（realtime_call_llm_cfg.json）
- 联网搜索（web_search）
- 作业判断 LLM（judgment_llm_cfg.json）

---

### 6. 语音合成节点（voice_synthesis_node）

#### 功能描述
将文本转换为语音音频。

#### 输入字段（VoiceSynthesisInput）

```python
class VoiceSynthesisInput(BaseModel):
    text: str                             # 要合成的文本
    child_age: int                        # 孩子年龄
    voice_type: str                       # 语音类型
```

#### 输出字段（VoiceSynthesisOutput）

```python
class VoiceSynthesisOutput(BaseModel):
    audio_url: str                        # 音频URL
```

#### 处理过程

1. **选择语音类型**
   - 12 岁以下：儿童语音
   - 12 岁及以上：正常语音

2. **语音合成**
   - 调用语音合成服务
   - 生成音频文件
   - 上传到对象存储

3. **返回 URL**
   - 返回音频文件的访问 URL

#### 集成服务
- 语音合成（TTS）
- 对象存储（S3 Storage）

---

### 7. 快速回复节点（quick_reply_node）【v2.0 新增】

#### 功能描述
超低延迟的快速回复，适用于短文本输入和简单问答。

#### 输入字段（QuickReplyInput）

```python
class QuickReplyInput(BaseModel):
    user_input_text: str                  # 用户输入文本
    child_name: str                       # 孩子姓名
    child_age: int                        # 孩子年龄
```

#### 输出字段（QuickReplyOutput）

```python
class QuickReplyOutput(BaseModel):
    quick_response: str                   # 快速回复（50字以内）
    followup_question: str                # 追问（可选）
    crisis_detected: bool                 # 是否检测到危机
```

#### 处理过程

1. **JSON 格式化输出**
   - 严格输出 JSON 格式，避免标点分割的脆弱性
   - 字段 1：quick_response（简短回复，50 字以内）
   - 字段 2：followup_question（追问，可选）
   - 字段 3：crisis_detected（危机检测布尔值）

2. **解析失败兜底**
   - 如果 JSON 解析失败，使用默认回复
   - 默认回复："我在听，请继续说～"
   - 追问："还有什么想聊的吗？"

3. **危机检测**
   - 快速检测负面情绪
   - 危机关键词："不想活了"、"讨厌自己"、"想死"等
   - 如果检测到危机，标记并返回关心话语

#### 集成服务
- 大语言模型（quick_reply_llm_cfg.json）

---

### 8. 轻量级聊天节点（quick_chat_node）【v2.0 新增】

#### 功能描述
轻量级聊天，提供比 quick_reply 更丰富的回复，适用于情感表达和简单聊天。

#### 输入字段（QuickChatInput）

```python
class QuickChatInput(BaseModel):
    user_input_text: str                  # 用户输入文本
    child_name: str                       # 孩子姓名
    child_age: int                        # 孩子年龄
    conversation_history: List[dict]      # 对话历史（最近3条）
```

#### 输出字段（QuickChatOutput）

```python
class QuickChatOutput(BaseModel):
    ai_response: str                      # AI响应（100字以内）
    crisis_detected: bool                 # 是否检测到危机
```

#### 处理过程

1. **上下文感知**
   - 保留最近 3 条对话历史
   - 理解对话上下文和情绪

2. **生成回复**
   - 字数限制在 100 字以内
   - 保持简洁、温暖
   - 适合孩子年龄的表达方式

3. **禁止复杂功能**
   - 不进行联网搜索
   - 不进行作业判断
   - 专注于对话交互

4. **危机检测**
   - 检测负面情绪
   - 如果检测到危机，提供情感支持

#### 集成服务
- 大语言模型（quick_chat_llm_cfg.json）

---

### 9. 场景类型判定函数（detect_scenario_type）【v2.0 新增】

#### 功能描述
自动判定对话场景类型，支持场景短路和快速路由。

#### 输入字段（DetectScenarioInput）

```python
class DetectScenarioInput(BaseModel):
    user_input_text: str                  # 用户输入文本
    trigger_type: str                     # 触发类型
    conversation_history: List[dict]      # 对话历史
```

#### 输出字段（DetectScenarioOutput）

```python
class DetectScenarioOutput(BaseModel):
    scenario_type: str                    # 场景类型
    confidence: float                     # 置信度
```

#### 处理过程

1. **危机检测（优先级最高）**
   - 检查危机关键词："不想活了"、"活着真没意思"等
   - 如果检测到危机，强制路由到 quick_reply

2. **负向短语过滤**
   - 避免误判："不想做作业"不归类为 homework
   - "不用搜"不归类为 web_search

3. **正向关键词匹配**
   - quick_reply："是谁"、"多少钱"、"这是什么"
   - homework："作业"、"题目"、"考试"
   - web_search："天气"、"新闻"、"为什么"
   - quick_chat："你好"、"再见"、"谢谢"

4. **优先级排序**
   - quick_reply > homework > web_search > quick_chat > normal_conversation

5. **特殊情况处理**
   - 输入很短（< 5 个字）：归类为 quick_reply

#### 集成服务
- 无（基于规则的快速判定）

---

### 10. 搜索规则判断函数（should_search_web_rule）【v2.0 新增】

#### 功能描述
使用规则+LLM混合判断是否需要联网搜索。

#### 输入参数

```python
user_input: str                          # 用户输入文本
```

#### 返回值

```python
tuple[bool, str]                         # (是否需要搜索, 判断方式)
```

#### 处理过程

1. **规则判断（覆盖 95% 场景）**
   - 需要搜索：天气、新闻、时事、为什么、怎么办
   - 不需要搜索：日常聊天、作业、情感、学习

2. **LLM 兜底判断（5% 场景）**
   - 使用低 temperature 模型（0.3）
   - 准确判断检索需求

3. **返回结果**
   - 返回判断结果和判断方式（规则匹配/LLM判断）

#### 集成服务
- 大语言模型（search_judgment_llm_cfg.json）

---

### 11. 路由决策函数（route_decision）

#### 功能描述
根据触发类型和作业状态决定下一步路由。

#### 输入字段（RouteDecisionInput）

```python
class RouteDecisionInput(BaseModel):
    trigger_type: str                     # 触发类型
    need_remind: bool                     # 是否需要提醒
```

#### 返回值

```python
str                                      # 目标节点名称
```

#### 路由逻辑

```python
if trigger_type == "care":
    return "主动关心"
elif trigger_type == "remind":
    return "作业提醒"
elif trigger_type == "practice":
    return "口语练习"
elif trigger_type == "conversation":
    return "实时对话"
```

#### 集成服务
- 无

---

## 可视化模式节点（graphs/visual_node.py）

可视化模式将复杂节点拆分为步骤级节点，每个节点只负责一个具体步骤。

### 1. 口语练习节点（拆分为 7 个子节点）

#### 1.1 语音识别节点（visual_asr_node）

**输入**：用户音频
**输出**：识别文本
**功能**：将语音转换为文本

#### 1.2 知识检索节点（visual_knowledge_retrieve_node）

**输入**：识别文本、对话历史
**输出**：知识点列表
**功能**：从知识库中检索相关知识点

#### 1.3 练习阶段判断节点（visual_practice_stage_node）

**输入**：知识点、对话历史
**输出**：练习阶段（引导/提问/延伸/总结）
**功能**：判断当前练习阶段

#### 1.4 场景选择节点（visual_scenario_select_node）

**输入**：练习阶段、孩子兴趣
**输出**：场景描述
**功能**：选择合适的练习场景

#### 1.5 对话生成节点（visual_dialogue_generate_node）

**输入**：场景描述、知识点
**输出**：对话内容
**功能**：生成对话内容

#### 1.6 知识提取节点（visual_knowledge_extract_node）

**输入**：对话内容、孩子输入
**输出**：提取的知识点
**功能**：从对话中提取知识点

#### 1.7 语音合成节点（visual_tts_node）

**输入**：对话内容
**输出**：音频 URL
**功能**：将对话转换为语音

### 2. 实时对话节点（拆分为 5 个子节点）

#### 2.1 搜索判断节点（visual_search_judgment_node）

**输入**：用户输入
**输出**：是否需要搜索
**功能**：判断是否需要联网搜索

#### 2.2 联网搜索节点（visual_web_search_node）

**输入**：用户输入
**输出**：搜索结果
**功能**：执行联网搜索

#### 2.3 对话生成节点（visual_conversation_generate_node）

**输入**：用户输入、搜索结果、对话历史
**输出**：对话内容
**功能**：生成对话内容

#### 2.4 作业判断节点（visual_homework_judgment_node）

**输入**：对话内容、作业列表
**输出**：作业完成判断
**功能**：判断是否提到作业完成

#### 2.5 语音合成节点（visual_conversation_tts_node）

**输入**：对话内容
**输出**：音频 URL
**功能**：将对话转换为语音

### 3. 主动关心节点（1 个节点）

**输入**：孩子信息、对话历史
**输出**：关心消息
**功能**：生成主动关心消息

### 4. 作业提醒节点（1 个节点）

**输入**：作业列表、当前时间
**输出**：提醒消息
**功能**：生成作业提醒消息

---

## 实时通话模式节点（graphs/realtime_call_graph.py）

实时通话模式是精简的低延迟模式，只包含核心节点。

### 1. 语音识别节点（realtime_asr）

**输入**：用户音频
**输出**：识别文本
**功能**：实时语音识别

### 2. 实时对话节点（realtime_llm）

**输入**：识别文本、对话历史
**输出**：对话内容
**功能**：实时对话生成

### 3. 语音合成节点（realtime_tts）

**输入**：对话内容
**输出**：音频 URL
**功能**：实时语音合成

**特点**：
- 延迟 1-2 秒
- 精简流程，去除非必要步骤
- 适合实时通话场景

---

## 全局状态定义（GlobalState）

### 字段说明

```python
class GlobalState(BaseModel):
    # 孩子基本信息
    child_id: str                          # 孩子ID
    child_name: str                        # 孩子姓名
    child_age: int                         # 孩子年龄
    child_interests: List[str]             # 孩子兴趣爱好
    
    # 作业信息
    homework_list: List[dict]              # 作业列表
    homework_status: str                   # 作业状态
    need_remind: bool                      # 是否需要提醒
    
    # 长期记忆
    conversation_history: List[dict]       # 对话历史
    learning_progress: dict                # 学习进度
    speaking_practice_count: int           # 口语练习次数
    
    # 对话相关
    user_input_text: str                   # 用户输入文本
    user_input_audio: Optional[File]       # 用户输入音频
    recognized_text: str                   # 识别出的文本
    
    # AI响应
    ai_response: str                       # AI文本响应
    ai_response_audio: Optional[str]       # AI音频响应URL
    
    # 触发场景
    trigger_type: str                      # 触发类型
    
    # 时间信息
    current_time: str                      # 当前时间
    
    # v2.0 新增字段
    quick_response: Optional[str]          # 快速回复
    followup_question: Optional[str]       # 追问问题
    scenario_type: Optional[str]           # 场景类型
    execution_path: List[str]              # 执行路径
    performance_metrics: dict              # 性能指标
    crisis_detected: bool                  # 危机检测
```

### 字段流转

1. **输入阶段**：用户输入 → `user_input_text` / `user_input_audio`
2. **处理阶段**：各节点处理 → 更新相关字段
3. **输出阶段**：`ai_response` / `ai_response_audio` / `quick_response` 等
4. **存储阶段**：`conversation_history` / `learning_progress` → MemoryStore

---

## 图的输入输出

### GraphInput（工作流输入）

```python
class GraphInput(BaseModel):
    child_id: str                          # 孩子ID
    child_name: str                        # 孩子姓名
    child_age: int                         # 孩子年龄
    child_interests: List[str]             # 孩子兴趣爱好
    trigger_type: Literal["conversation", "practice", "care", "remind"]  # 触发类型
    user_input_text: str                   # 用户输入文本
    user_input_audio: Optional[File]       # 用户输入音频
    homework_list: List[dict]              # 作业列表
    scenario_type: Optional[str]           # 场景类型（v2.0）
```

### GraphOutput（工作流输出）

```python
class GraphOutput(BaseModel):
    ai_response: str                       # AI文本响应
    ai_response_audio: Optional[str]       # AI音频响应URL
    trigger_type: str                      # 触发类型
    homework_status: str                   # 作业状态
    speaking_practice_count: int           # 口语练习次数
    quick_response: Optional[str]          # 快速回复（v2.0）
    followup_question: Optional[str]       # 追问问题（v2.0）
    scenario_type: Optional[str]           # 场景类型（v2.0）
    execution_path: List[str]              # 执行路径（v2.0）
    performance_metrics: dict              # 性能指标（v2.0）
    crisis_detected: bool                  # 危机检测（v2.0）
```

---

## 数据流示例

### 示例 1：实时对话场景

```
输入：
{
  "child_id": "child_001",
  "child_name": "小明",
  "child_age": 10,
  "trigger_type": "conversation",
  "user_input_text": "今天天气怎么样？"
}

流程：
load_memory
  ├─ 加载对话历史
  ├─ 加载学习进度
  └─ 返回记忆数据

detect_scenario_type
  ├─ 检测到"天气"关键词
  ├─ 判定场景类型：web_search
  └─ 返回场景类型

wrap_realtime_conversation
  ├─ should_search_web_rule: 规则匹配，需要搜索
  ├─ 调用联网搜索工具
  ├─ 基于搜索结果生成回答
  └─ 返回对话内容

voice_synthesis
  ├─ 将对话转换为语音
  └─ 返回音频 URL

save_memory
  ├─ 保存对话记录
  └─ 更新学习进度

输出：
{
  "ai_response": "今天天气不错，气温 25°C，适合出门玩～",
  "ai_response_audio": "https://...",
  "scenario_type": "web_search",
  "execution_path": ["realtime_conversation", "web_search"],
  "performance_metrics": {"cache_hit": false}
}
```

### 示例 2：危机检测场景（v2.0）

```
输入：
{
  "child_id": "child_002",
  "child_name": "小红",
  "child_age": 9,
  "trigger_type": "conversation",
  "user_input_text": "活着真没意思"
}

流程：
load_memory
  └─ 加载记忆数据

detect_scenario_type
  ├─ 检测到"活着"和"没意思"（部分匹配）
  ├─ 判定为危机场景
  ├─ 强制路由到 quick_reply
  └─ 返回场景类型

wrap_quick_reply
  ├─ 检查短期缓存：未命中
  ├─ 调用 quick_reply_node
  ├─ LLM 检测到危机信号
  ├─ crisis_detected = true
  ├─ 生成关心话术："怎么会有这样的想法呀"
  ├─ 不拼接追问
  └─ 缓存响应

voice_synthesis
  └─ 语音合成

save_memory
  └─ 保存对话记录

输出：
{
  "ai_response": "怎么会有这样的想法呀",
  "quick_response": "怎么会有这样的想法呀",
  "followup_question": "",  # 危机时不追问
  "scenario_type": "quick_reply",
  "execution_path": ["quick_reply"],
  "crisis_detected": true
}
```

### 示例 3：口语练习场景

```
输入：
{
  "child_id": "child_003",
  "child_name": "小刚",
  "child_age": 8,
  "trigger_type": "practice",
  "user_input_text": "我想练习英语对话"
}

流程：
load_memory
  └─ 加载记忆数据

wrap_speaking_practice
  ├─ 判断练习阶段：主动引导
  ├─ 选择场景：学校场景
  ├─ 生成引导问题："在学校里，你最喜欢的课是什么？"
  ├─ 从对话中提取知识点：school, class
  └─ 返回反馈

voice_synthesis
  └─ 语音合成

save_memory
  ├─ 保存对话记录
  ├─ 更新学习进度
  └─ 存储知识点

输出：
{
  "ai_response": "在学校里，你最喜欢的课是什么？我们可以聊聊上课的有趣事情～",
  "speaking_practice_count": 1,
  "scenario_type": "practice",
  "execution_path": ["speaking_practice"]
}
```

---

## 总结

AI 陪伴孩子智能体工作流包含以下核心节点：

**完整模式**：
1. 长期记忆节点
2. 作业检查节点
3. 主动关心节点
4. 口语练习节点（4 阶段）
5. 实时对话节点（支持联网搜索和作业判断）
6. 语音合成节点
7. 快速回复节点（v2.0）
8. 轻量级聊天节点（v2.0）

**可视化模式**：
- 口语练习：7 个步骤节点
- 实时对话：5 个步骤节点
- 主动关心：1 个节点
- 作业提醒：1 个节点

**实时通话模式**：
- 语音识别
- 实时对话
- 语音合成

所有节点都遵循统一的输入输出规范，使用 Pydantic 类型标注，确保数据类型安全。
